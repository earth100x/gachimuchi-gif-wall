# Story 2.1: Infinite Scroll Implementation

## Status

Draft

## Story

**As a** user,
**I want** to automatically load more GIFs as I scroll down,
**so that** I can browse continuously without manual pagination.

## Acceptance Criteria

1. Intersection Observer API implemented for scroll detection
2. Automatic API calls triggered when user reaches bottom
3. New GIFs appended to existing grid without page refresh
4. Loading indicator shown during fetch operations
5. Scroll position maintained during new content loading
6. Performance optimized to prevent excessive API calls

## Tasks / Subtasks

- [ ] Task 1: Create useInfiniteScroll hook (AC: 1, 6)

  - [ ] Create `src/hooks/useInfiniteScroll.ts` hook
  - [ ] Implement Intersection Observer API for scroll detection
  - [ ] Add throttling/debouncing to prevent excessive API calls
  - [ ] Handle observer cleanup and memory management
  - [ ] Create `src/hooks/index.ts` export file
  - [ ] Add unit tests for useInfiniteScroll hook

- [ ] Task 2: Enhance useTenorAPI hook for pagination (AC: 2, 3)

  - [ ] Update `src/hooks/useTenorAPI.ts` to support pagination
  - [ ] Add `nextToken` state management for API pagination
  - [ ] Implement `loadMoreGifs` function for additional API calls
  - [ ] Add `hasMore` state to track if more content is available
  - [ ] Update error handling for pagination scenarios
  - [ ] Add unit tests for pagination functionality

- [ ] Task 3: Update GIFGrid component for infinite scroll (AC: 3, 4)

  - [ ] Update `src/components/GIFGrid/GIFGrid.tsx` to support infinite scroll
  - [ ] Add intersection observer target element at bottom of grid
  - [ ] Integrate useInfiniteScroll hook with onLoadMore callback
  - [ ] Update loading state to show spinner at bottom during fetch
  - [ ] Maintain scroll position during new content loading
  - [ ] Add unit tests for infinite scroll behavior

- [ ] Task 4: Update main page integration (AC: 2, 5)

  - [ ] Update `src/app/page.tsx` to use enhanced useTenorAPI hook
  - [ ] Integrate useInfiniteScroll hook with GIFGrid component
  - [ ] Implement proper state management for infinite scroll
  - [ ] Add error handling for infinite scroll failures
  - [ ] Test infinite scroll functionality with real API data

- [ ] Task 5: Add comprehensive testing (AC: 1-6)

  - [ ] Create unit tests for `src/hooks/useInfiniteScroll.test.ts`
  - [ ] Update unit tests for `src/hooks/useTenorAPI.test.ts`
  - [ ] Update unit tests for `src/components/GIFGrid.test.tsx`
  - [ ] Add integration tests for infinite scroll behavior
  - [ ] Test performance optimization and throttling
  - [ ] Test error scenarios and recovery

## Dev Notes

### Previous Story Insights

From Story 1.3 completion:

- GIFGrid component successfully implemented with responsive CSS Grid layout
- useTenorAPI hook established with proper error handling and loading states
- Component architecture follows established patterns with proper TypeScript interfaces
- Comprehensive testing framework in place with Jest and React Testing Library
- All components properly integrated in main page with dark theme styling

### Component Specifications

**useInfiniteScroll Hook** [Source: architecture/components.md#infinite-scroll-hook]:

```typescript
interface UseInfiniteScrollOptions {
  threshold?: number;
  rootMargin?: string;
  enabled?: boolean;
}

interface UseInfiniteScrollReturn {
  loadMore: () => void;
  isIntersecting: boolean;
  targetRef: React.RefObject<HTMLDivElement>;
}

export const useInfiniteScroll = (
  callback: () => void,
  options?: UseInfiniteScrollOptions
): UseInfiniteScrollReturn => {
  // Implementation with Intersection Observer API
  // Throttling to prevent excessive calls
  // Proper cleanup and memory management
};
```

**Enhanced useTenorAPI Hook** [Source: architecture/frontend-architecture.md#service-example]:

```typescript
interface UseTenorAPIReturn {
  gifs: GIF[];
  loading: boolean;
  error: string | null;
  hasMore: boolean;
  searchGifs: (query: string) => Promise<void>;
  loadMoreGifs: () => Promise<void>;
}

export const useTenorAPI = (): UseTenorAPIReturn => {
  const [gifs, setGifs] = useState<GIF[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [hasMore, setHasMore] = useState(true);
  const [nextToken, setNextToken] = useState<string | null>(null);

  // Implementation with pagination support
};
```

**Updated GIFGrid Component** [Source: architecture/components.md#gif-grid-component]:

```typescript
interface GIFGridProps {
  gifs: GIF[];
  onLoadMore: () => void;
  loading: boolean;
  hasMore: boolean;
}

export const GIFGrid: React.FC<GIFGridProps> = ({
  gifs,
  onLoadMore,
  loading,
  hasMore,
}) => {
  const { targetRef } = useInfiniteScroll(onLoadMore, {
    enabled: hasMore && !loading,
  });

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {gifs.map((gif) => (
        <GIFItem key={gif.id} gif={gif} />
      ))}
      {loading && <LoadingSpinner />}
      {hasMore && <div ref={targetRef} data-testid="infinite-scroll-trigger" />}
    </div>
  );
};
```

### File Locations

Based on unified project structure [Source: architecture/unified-project-structure.md]:

- `src/hooks/useInfiniteScroll.ts` - Infinite scroll logic hook
- `src/hooks/useTenorAPI.ts` - Enhanced API hook with pagination
- `src/hooks/index.ts` - Hook exports
- `src/components/GIFGrid/GIFGrid.tsx` - Updated grid component
- `src/app/page.tsx` - Main page integration

### Technical Implementation Details

**Intersection Observer API** [Source: architecture/frontend-architecture.md#component-organization]:

- Use Intersection Observer API for efficient scroll detection
- Implement proper threshold and rootMargin for optimal trigger timing
- Add throttling/debouncing to prevent excessive API calls
- Handle observer cleanup to prevent memory leaks

**Pagination Strategy** [Source: architecture/frontend-architecture.md#state-management-patterns]:

- Use Tenor API's `pos` parameter for pagination
- Maintain `nextToken` state for tracking pagination position
- Implement `hasMore` flag to prevent unnecessary API calls
- Handle edge cases when no more content is available

**Performance Optimization** [Source: architecture/coding-standards.md#performance]:

- Throttle intersection observer callbacks
- Implement proper loading states to prevent duplicate requests
- Use React.memo for expensive components if needed
- Maintain scroll position during content updates

### State Management Integration

**Enhanced State Structure** [Source: architecture/frontend-architecture.md#state-structure]:

```typescript
interface AppState {
  gifs: GIF[];
  loading: boolean;
  error: string | null;
  hasMore: boolean;
  nextToken: string | null;
}

// State updates for infinite scroll
const addGifs = (newGifs: GIF[]) => {
  setGifs((prev) => [...prev, ...newGifs]);
};

const setPaginationState = (hasMore: boolean, nextToken: string | null) => {
  setHasMore(hasMore);
  setNextToken(nextToken);
};
```

### Technical Constraints

**Technology Stack** [Source: architecture/tech-stack.md]:

- TypeScript 5.9.2 for type safety
- Next.js 15.1.8 for framework
- React Hooks 19.1.1 for state management
- Intersection Observer API for scroll detection
- Tailwind CSS 4.0 for styling

**Coding Standards** [Source: architecture/coding-standards.md]:

- Type Safety: Always use TypeScript interfaces for hook returns and component props
- Performance: Implement throttling and proper cleanup for intersection observer
- Error Handling: Handle pagination errors gracefully with user feedback
- Accessibility: Ensure infinite scroll doesn't break keyboard navigation
- Testing: Comprehensive unit and integration tests for scroll behavior

### Testing Strategy

**Test File Location**: `src/__tests__/` directory [Source: architecture/testing-strategy.md#test-organization]

**Testing Framework**: Jest + React Testing Library [Source: architecture/tech-stack.md#frontend-testing]

**Specific Testing Requirements**:

- Test useInfiniteScroll hook with mock intersection observer
- Test useTenorAPI pagination functionality
- Test GIFGrid infinite scroll integration
- Test performance optimization and throttling
- Test error scenarios and recovery
- Test scroll position maintenance
- Mock Intersection Observer API for consistent testing

**Test Examples** [Source: architecture/testing-strategy.md#test-examples]:

```typescript
// useInfiniteScroll.test.ts
describe("useInfiniteScroll", () => {
  it("calls callback when element intersects", () => {
    const callback = jest.fn();
    const { result } = renderHook(() => useInfiniteScroll(callback));

    // Simulate intersection
    // Assert callback called
  });
});

// GIFGrid.test.tsx
describe("GIFGrid", () => {
  it("shows loading spinner during infinite scroll", () => {
    render(
      <GIFGrid
        gifs={mockGIFs}
        onLoadMore={jest.fn()}
        loading={true}
        hasMore={true}
      />
    );

    expect(screen.getByTestId("loading-spinner")).toBeInTheDocument();
  });
});
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-12 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
